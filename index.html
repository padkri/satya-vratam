<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sri Satya Narayana Vratam</title>
    <link href="https://fonts.googleapis.com/css2?family=Gautami&family=Noto+Sans+Devanagari&family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #FF9933; /* Saffron */
            --secondary-color: #FFFFFF;
            --text-color: #333333;
            --bg-color: #FFF8E1; /* Light cream */
            --navbar-bg: #D2691E; /* Chocolate/Wood color */
            --completed-color: #4CAF50; /* Green */
            --active-color: #FFC107; /* Amber */
            --border-color: #E0E0E0;
        }

        body {
            font-family: 'Poppins', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        header {
            background-color: var(--navbar-bg);
            color: var(--secondary-color);
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        header h1 {
            margin: 0;
            font-size: 1.5em;
        }

        .controls {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .language-selector label {
            font-weight: bold;
            margin-right: 10px;
        }
        
        #language-select {
            padding: 5px;
            border-radius: 5px;
            border: 1px solid var(--border-color);
            background-color: var(--secondary-color);
            font-family: 'Poppins', sans-serif;
        }

        #navbar {
            background-color: #F5F5F5;
            padding: 10px;
            overflow-x: auto;
            white-space: nowrap;
            border-bottom: 2px solid var(--border-color);
            -webkit-overflow-scrolling: touch; /* For smooth scrolling on iOS */
        }

        #navbar a {
            display: inline-block;
            color: var(--text-color);
            text-align: center;
            padding: 8px 12px;
            text-decoration: none;
            font-size: 0.9em;
            border-radius: 20px;
            margin: 0 5px;
            transition: background-color 0.3s, color 0.3s, border-color 0.3s;
            border: 1px solid transparent;
        }

        #navbar a.completed {
            background-color: var(--completed-color);
            color: white;
            border-color: #388E3C;
        }

        #navbar a.active {
            background-color: var(--active-color);
            font-weight: bold;
            border-color: #FFA000;
        }

        main {
            flex-grow: 1;
            padding: 15px; /* Reduced padding to give more space */
            max-width: 1200px; /* Increased further */
            margin: 20px auto;
            width: 100%;
            box-sizing: border-box;
        }

        .step-content {
            display: none;
            background-color: var(--secondary-color);
            padding: 15px; /* Further reduced padding */
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
            animation: fadeIn 0.5s ease-in-out;
            border: 1px solid var(--border-color);
        }

        .step-content.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        h2 {
            color: var(--navbar-bg);
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 10px;
            margin-top: 0;
            font-size: 1.8em;
        }
        
        h3 {
            color: var(--navbar-bg);
            margin-top: 25px;
            font-size: 1.4em;
        }
        
        h4 {
            color: var(--navbar-bg);
            margin-top: 20px;
            font-size: 1.2em;
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
        }

        .sloka {
            background-color: #FFF8E1;
            border-left: 4px solid var(--primary-color);
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
        }

        .sloka-text {
            display: none;
            font-size: 1.1em;
            line-height: 1.8;
        }
        
        .sloka-text.lang-telugu {
            font-family: 'Gautami', sans-serif;
        }

        .sloka-text.lang-devanagari {
            font-family: 'Noto Sans Devanagari', sans-serif;
        }
        
        .sloka-text.lang-english {
            font-style: italic;
        }

        .navigation-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
        }

        .nav-btn {
            padding: 12px 24px;
            font-size: 1em;
            cursor: pointer;
            border: none;
            border-radius: 5px;
            background-color: var(--primary-color);
            color: white;
            transition: background-color 0.3s, transform 0.2s;
            font-weight: bold;
        }
        
        .nav-btn:hover {
            background-color: #e68a00;
        }
        
        .nav-btn:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
            transform: translateY(0);
        }

        .copy-button {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            font-size: 0.9em;
            cursor: pointer;
            border: 1px solid var(--primary-color);
            border-radius: 5px;
            background-color: transparent;
            color: var(--primary-color);
            margin-bottom: 15px;
            transition: background-color 0.3s, color 0.3s;
        }
        .copy-button:hover {
            background-color: var(--primary-color);
            color: white;
        }
        
        ul.checklist {
            list-style-type: none;
            padding-left: 0;
        }
        
        ul.checklist li {
            background-color: #fcfcfc;
            padding: 10px;
            border-bottom: 1px solid #f0f0f0;
            margin-bottom: 5px;
            border-radius: 4px;
        }
        
        ul.checklist li ul {
            padding-left: 20px;
            list-style-type: '– ';
            margin-top: 8px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        th, td {
            border: 1px solid var(--border-color);
            padding: 12px;
            text-align: left;
        }
        
        th {
            background-color: #f2f2f2;
            font-weight: bold;
        }
        
        tbody tr:nth-child(even) {
            background-color: #fafafa;
        }
        
        .graha-table td:first-child {
            font-weight: bold;
        }
        
        .graha-table .deity-row {
            background-color: #f9f9f9;
        }

        .parivaara-container {
            display: flex;
            gap: 20px;
        }

        .vertical-progress {
            width: 200px;
            flex-shrink: 0;
        }

        .vertical-progress .progress-step {
            padding: 10px;
            margin-bottom: 10px;
            border-left: 4px solid var(--border-color);
            transition: all 0.3s;
            cursor: pointer;
        }
        
        .vertical-progress .progress-step.active {
            border-left-color: var(--active-color);
            background-color: #fffbeb;
            font-weight: bold;
        }

        .vertical-progress .progress-step.completed {
            border-left-color: var(--completed-color);
        }
        
        .parivaara-content {
            flex-grow: 1;
        }

        .parivaara-part {
            display: none;
        }

        .graha-card {
            display: none;
            border: 1px solid #eee;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }
        
        /* Interactive Step Styles */
        .step-description {
            margin: 1rem 0;
            font-style: italic;
            color: #666;
        }

        .parts-navigation {
            margin: 2rem 0;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }

        .parts-navigation h3 {
            margin: 0 0 1rem 0;
            color: #495057;
        }

        .parts-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .part-button {
            padding: 0.5rem 1rem;
            border: 1px solid #ccc;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.9rem;
        }

        .part-button:hover {
            background: #e9ecef;
            border-color: #adb5bd;
        }

        .part-button.active {
            background: #007bff;
            color: white;
            border-color: #007bff;
            font-weight: bold;
        }

        .part-content {
            margin: 1rem 0;
        }

        .part-header {
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #dee2e6;
        }

        .part-header h3 {
            margin: 0;
            color: #212529;
        }

        .part-subtitle {
            margin: 0.5rem 0 0 0;
            color: #6c757d;
            font-size: 1.1rem;
        }

        .part-description {
            margin: 0.5rem 0 0 0;
            color: #6c757d;
        }

        /* Graha Navigation Styles */
        .graha-navigation {
            margin: 1.5rem 0;
            padding: 1rem;
            background: #fff3cd;
            border-radius: 6px;
            border: 1px solid #ffeaa7;
        }

        .graha-navigation h4 {
            margin: 0 0 1rem 0;
            color: #856404;
        }

        .graha-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 0.3rem;
            margin-bottom: 1rem;
        }

        .graha-button {
            padding: 0.4rem 0.8rem;
            border: 1px solid #ddd;
            background: white;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.85rem;
        }

        .graha-button:hover {
            background: #fff3cd;
            border-color: #ffeaa7;
        }

        .graha-button.active {
            background: #ffc107;
            color: #212529;
            border-color: #ffc107;
            font-weight: bold;
        }

        .graha-controls {
            display: flex;
            justify-content: space-between;
            margin: 1rem 0;
        }

        .graha-nav-btn {
            padding: 0.5rem 1rem;
            border: 1px solid #6c757d;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .graha-nav-btn:hover:not(:disabled) {
            background: #6c757d;
            color: white;
        }

        .graha-nav-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .graha-content {
            margin: 1rem 0;
            padding: 1rem;
            background: white;
            border-radius: 6px;
            border: 1px solid #dee2e6;
        }

        .graha-header {
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #dee2e6;
        }

        .graha-header h4 {
            margin: 0;
            color: #495057;
        }

        /* Interactive Step Navigation Styles */
        .parivaara-parts-nav {
            margin: 20px 0;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }

        .parivaara-part-btn {
            padding: 10px 20px;
            margin: 5px;
            border: 1px solid #ccc;
            background: white;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9rem;
        }

        .parivaara-part-btn:hover {
            background: #e9ecef;
            border-color: #adb5bd;
        }

        .parivaara-part-btn.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
            font-weight: bold;
        }

        .parivaara-content {
            margin: 20px 0;
            padding: 20px;
            background: white;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }

        .parivaara-graha-nav {
            margin: 15px 0;
            padding: 15px;
            background-color: #fff3cd;
            border-radius: 6px;
            border: 1px solid #ffeaa7;
        }

        .parivaara-graha-btn {
            padding: 8px 15px;
            margin: 3px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.85rem;
        }

        .parivaara-graha-btn:hover {
            background: #fff3cd;
            border-color: #ffeaa7;
        }

        .parivaara-graha-btn.active {
            background: #ffc107;
            color: #212529;
            border-color: #ffc107;
            font-weight: bold;
        }

        .parivaara-graha-content {
            margin: 15px 0;
            padding: 15px;
            background: white;
            border-radius: 6px;
            border: 1px solid #dee2e6;
        }

        .graha-attribute {
            font-style: italic;
            color: #666;
            margin: 10px 0;
        }

        .location-info {
            background-color: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 8px 12px;
            margin: 10px 0;
            border-radius: 4px;
            font-weight: bold;
            color: #1565c0;
        }

        /* Graha Diagram Styles */
        .graha-diagram-container {
            margin: 20px 0;
            text-align: center;
            background-color: #fafafa;
            border-radius: 8px;
            padding: 5px;
            border: 1px solid #e0e0e0;
            overflow: hidden;
            width: 100%;
            box-sizing: border-box;
            min-width: 0;
        }

        .graha-diagram {
            display: block;
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
        }

        .graha-diagram h4 {
            margin: 0 0 10px 0;
            color: #333;
            font-size: 1.1em;
        }

        .graha-diagram svg {
            border: 1px solid #ccc;
            border-radius: 5px;
            background-color: white;
            width: 100%;
            max-width: 100%;
            height: auto;
            display: block;
            margin: 0 auto;
            box-sizing: border-box;
        }

        #peetam-svg-container {
            min-height: 100px;
            display: block;
            width: 100%;
            max-width: 100%;
            overflow: hidden;
            box-sizing: border-box;
            min-width: 0;
            padding: 0;
        }

        #peetam-svg-container svg {
            width: 100%;
            max-width: 100%;
            height: auto;
            display: block;
            margin: 0 auto;
            box-sizing: border-box;
        }

        /* Additional SVG fixes for cross-browser compatibility */
        .graha-diagram-container svg,
        #peetam-svg-container svg {
            /* Ensure SVG respects container width */
            min-width: 0;
            flex-shrink: 1;
        }

        /* Force SVG viewport to be responsive */
        .graha-diagram-container svg[width],
        #peetam-svg-container svg[width] {
            width: 100% !important;
        }

        .graha-diagram-container svg[height],
        #peetam-svg-container svg[height] {
            height: auto !important;
        }

        /* Enhanced highlighting styles - thick lines with glow effects */
        .graha-diagram svg .highlight-main circle,
        .graha-diagram svg .highlight-main rect,
        .graha-diagram svg .highlight-main polygon {
            stroke: #ff5722 !important;
            stroke-width: 6px !important;
            filter: drop-shadow(0 0 12px rgba(255, 87, 34, 0.8)) !important;
            animation: pulseGlow 2s infinite alternate !important;
        }

        .graha-diagram svg .highlight-deity circle,
        .graha-diagram svg .highlight-deity rect,
        .graha-diagram svg .highlight-deity polygon {
            stroke: #4caf50 !important;
            stroke-width: 4px !important;
            filter: drop-shadow(0 0 8px rgba(76, 175, 80, 0.8)) !important;
        }

        /* Make planet names bigger and more prominent when highlighted */
        .graha-diagram svg .highlight-main text.label {
            font-size: 18px !important;
            font-weight: bold !important;
            fill: #ff5722 !important;
            filter: drop-shadow(0 0 4px rgba(255, 87, 34, 0.8)) !important;
        }

        /* Arrow pointing to highlighted element */
        .graha-diagram svg .highlight-main::before {
            content: "👆";
            position: absolute;
            font-size: 24px;
            animation: bounce 1.5s infinite;
        }

        /* Enhanced glow animation */
        @keyframes pulseGlow {
            0% { 
                filter: drop-shadow(0 0 12px rgba(255, 87, 34, 0.8));
                stroke-width: 6px;
            }
            100% { 
                filter: drop-shadow(0 0 20px rgba(255, 87, 34, 1));
                stroke-width: 8px;
            }
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% {
                transform: translateY(0);
            }
            40% {
                transform: translateY(-10px);
            }
            60% {
                transform: translateY(-5px);
            }
        }

        /* Special styling for graha elements on hover */
        .graha-diagram g[id^="g"]:hover circle,
        .graha-diagram g[id^="g"]:hover rect,
        .graha-diagram g[id^="g"]:hover polygon,
        .graha-diagram g[id^="g"]:hover path {
            opacity: 0.8;
            cursor: pointer;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            header {
                flex-direction: column;
                gap: 10px;
                padding: 15px;
            }
            header h1 {
                font-size: 1.2em;
            }
            main {
                padding: 10px;
                margin-top: 10px;
                max-width: 100%; /* Remove width restriction on mobile */
            }
            .step-content {
                padding: 15px; /* Increased from 15px to accommodate SVG better */
            }
            h2 {
                font-size: 1.5em;
            }
            h3 {
                font-size: 1.2em;
            }
            .parivaara-container {
                flex-direction: column;
            }
            .vertical-progress {
                width: 100%;
                display: flex;
                justify-content: space-around;
                margin-bottom: 20px;
            }
            .vertical-progress .progress-step {
                border-left: none;
                border-bottom: 4px solid var(--border-color);
                padding: 8px;
                margin-bottom: 0;
                text-align: center;
            }
            .vertical-progress .progress-step.active {
                border-bottom-color: var(--active-color);
            }
            .vertical-progress .progress-step.completed {
                border-bottom-color: var(--completed-color);
            }
            .parts-buttons {
                flex-direction: column;
            }
            
            .part-button {
                width: 100%;
                text-align: center;
            }
            
            .graha-buttons {
                justify-content: center;
            }
            
            .graha-controls {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .graha-nav-btn {
                width: 100%;
            }
            
            /* Mobile diagram adjustments */
            .graha-diagram-container {
                padding: 3px;
                margin: 10px 0;
                width: 100%;
                box-sizing: border-box;
                overflow: hidden;
            }
            
            .graha-diagram {
                width: 100%;
                max-width: 100%;
                box-sizing: border-box;
            }
            
            .graha-diagram svg {
                width: 100%;
                max-width: 100%;
                height: auto;
                box-sizing: border-box;
                border: 1px solid #ccc;
            }
            
            #peetam-svg-container {
                width: 100%;
                max-width: 100%;
                overflow: hidden;
                box-sizing: border-box;
                padding: 0;
                margin: 0;
            }
            
            #peetam-svg-container svg {
                width: 100%;
                max-width: 100%;
                height: auto;
                box-sizing: border-box;
            }
        }
    </style>
</head>
<body>

    <header>
        <h1>Sri Satya Narayana Vratam</h1>
        <div class="controls">
            <div class="language-selector">
                <label for="language-select">Language:</label>
                <select id="language-select">
                    <option value="english">English</option>
                    <option value="devanagari">Devanagari</option>
                    <option value="telugu">Telugu</option>
                </select>
            </div>
        </div>
    </header>

    <nav id="navbar"></nav>

    <main id="main-content">
        <!-- Step content will be dynamically inserted here by JavaScript -->
    </main>
    
    <div id="navigation-container" style="padding: 20px;">
         <div class="navigation-buttons">
            <button id="prev-btn" class="nav-btn">Previous</button>
            <button id="next-btn" class="nav-btn">Next</button>
        </div>
    </div>

    <script>
    // This script loads the JSON data from vratam.json and dynamically builds the webpage.
    document.addEventListener('DOMContentLoaded', async function() {
        try {
            let data;
            
            // Load data from external JSON file
            const response = await fetch('vratam.json');
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            data = await response.json();
            console.log('Loaded data from vratam.json');
            
            const steps = data.steps || [];
            const grahas = data.grahas || [];
            const dikpalakas = data.dikpalakas || [];
            const ganapathiPoojaServices = data.ganapathi_pooja_services || [];
            const angaPoojaServices = data.anga_pooja_services || [];

        const navbar = document.getElementById('navbar');
        const mainContent = document.getElementById('main-content');
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');
        const languageSelect = document.getElementById('language-select');

        let currentStep = 0;
        let maxStepReached = 0;
        
        // Global variables for interactive step navigation
        let currentPart = 0;
        let currentSubItem = 0;

        // Mapping between graha names and SVG IDs for highlighting
        const grahaMapping = {
            "Sun": { main: "g1", ruling: "g1a", coruling: "g1p" },
            "Moon": { main: "g2", ruling: "g2a", coruling: "g2p" },
            "Mars": { main: "g3", ruling: "g3a", coruling: "g3p" },
            "Mercury": { main: "g4", ruling: "g4a", coruling: "g4p" },
            "Jupiter": { main: "g5", ruling: "g5a", coruling: "g5p" },
            "Venus": { main: "g6", ruling: "g6a", coruling: "g6p" },
            "Saturn": { main: "g7", ruling: "g7a", coruling: "g7p" },
            "Rahu": { main: "g8", ruling: "g8a", coruling: "g8p" },
            "Ketu": { main: "g9", ruling: "g9a", coruling: "g9p" }
        };

        // Mapping between Lokapalaka names and SVG IDs for highlighting
        const lokapalakaMapping = {
            "Ganapathi": { main: "l1" },
            "Brahma": { main: "l2" },
            "Mahalakshmi": { main: "l3" },
            "MahaVishnu": { main: "l4" },
            "Rudra (Fire element)": { main: "l5" },
            "Gouri (Water element)": { main: "l6" }
        };

        // Function to create a sloka element
        function createSlokaElement(slokaData) {
            const slokaContainer = document.createElement('div');
            slokaContainer.className = 'sloka';
            
            const devanagari = document.createElement('p');
            devanagari.className = 'sloka-text lang-devanagari';
            devanagari.style.whiteSpace = 'pre-wrap';
            devanagari.textContent = slokaData.devanagari;
            slokaContainer.appendChild(devanagari);
            
            const english = document.createElement('p');
            english.className = 'sloka-text lang-english';
            english.style.whiteSpace = 'pre-wrap';
            english.textContent = slokaData.english;
            slokaContainer.appendChild(english);
            
            const telugu = document.createElement('p');
            telugu.className = 'sloka-text lang-telugu';
            telugu.style.whiteSpace = 'pre-wrap';
            telugu.textContent = slokaData.telugu;
            slokaContainer.appendChild(telugu);

            return slokaContainer;
        }
        
        // Function to create a Graha table
        function createGrahaTable() {
            const table = document.createElement('table');
            table.className = 'graha-table';
            const thead = table.createTHead();
            const headerRow = thead.insertRow();
            ['Deity Type', 'Name & Location', 'Dhyana Sloka & Naama Mantra'].forEach(text => {
                const th = document.createElement('th');
                th.textContent = text;
                headerRow.appendChild(th);
            });

            const tbody = table.createTBody();
            if (grahas && grahas.length > 0) {
                grahas.forEach(graha => {
                    // Planet Row
                    let row = tbody.insertRow();
                    row.insertCell().textContent = 'Planet';
                    row.insertCell().innerHTML = `${graha.planet.name} <br><small>(${graha.planet.attribute})</small><br><b>Location: ${graha.planet.location}</b>`;
                    row.insertCell().innerHTML = `<p><em>${graha.planet.dhyana_sloka}</em></p><strong>${graha.planet.naama_mantra}</strong>`;

                    // Ruling Deity Row
                    row = tbody.insertRow();
                    row.classList.add('deity-row');
                    row.insertCell().textContent = 'Ruling Deity';
                    row.insertCell().innerHTML = `${graha.ruling_deity.name}<br><b>Location: ${graha.ruling_deity.location}</b>`;
                    row.insertCell().innerHTML = `<p><em>${graha.ruling_deity.dhyana_sloka}</em></p><strong>${graha.ruling_deity.naama_mantra}</strong>`;

                    // Co-ruling Deity Row
                    row = tbody.insertRow();
                    row.classList.add('deity-row');
                    row.insertCell().textContent = 'Co-ruling Deity';
                    row.insertCell().innerHTML = `${graha.coruling_deity.name}<br><b>Location: ${graha.coruling_deity.location}</b>`;
                    row.insertCell().innerHTML = `<p><em>${graha.coruling_deity.dhyana_sloka}</em></p><strong>${graha.coruling_deity.naama_mantra}</strong>`;
                });
            } else {
                // Fallback if no grahas data
                const row = tbody.insertRow();
                row.insertCell().colSpan = 3;
                row.insertCell().textContent = 'No graha data available';
            }
            return table;
        }

        // Function to create Dikpalaka table
        function createDikpalakaTable() {
            const table = document.createElement('table');
            const thead = table.createTHead();
            const headerRow = thead.insertRow();
            const headers = {
                "deity": {"devanagari": "देवता", "english": "Deity", "telugu": "దేవత"},
                "sloka_mantra": {"devanagari": "ध्यान श्लोक व नाम मन्त्र", "english": "Dhyana Sloka & Naama Mantra", "telugu": "ధ్యాన శ్లోక మరియు నామ మంత్రం"}
            };

            Object.keys(headers).forEach(key => {
                const th = document.createElement('th');
                Object.keys(headers[key]).forEach(lang => {
                    const span = document.createElement('span');
                    span.className = `lang-${lang}`;
                    span.textContent = headers[key][lang];
                    th.appendChild(span);
                });
                headerRow.appendChild(th);
            });
            
            const tbody = table.createTBody();
            dikpalakas.forEach(dp => {
                const row = tbody.insertRow();
                const nameCell = row.insertCell();
                const slokaMantraCell = row.insertCell();
                
                nameCell.textContent = dp.name;
                
                // Create dhyana sloka elements
                const dhyanaContainer = document.createElement('div');
                Object.keys(dp.dhyana_sloka).forEach(lang => {
                    const p = document.createElement('p');
                    p.className = `sloka-text lang-${lang}`;
                    p.style.whiteSpace = 'pre-wrap';
                    p.style.fontStyle = 'italic';
                    p.textContent = dp.dhyana_sloka[lang];
                    dhyanaContainer.appendChild(p);
                });
                
                // Create naama mantra elements
                const mantraContainer = document.createElement('div');
                Object.keys(dp.naama_mantra).forEach(lang => {
                    const p = document.createElement('p');
                    p.className = `sloka-text lang-${lang}`;
                    p.style.whiteSpace = 'pre-wrap';
                    p.style.fontWeight = 'bold';
                    p.textContent = dp.naama_mantra[lang];
                    mantraContainer.appendChild(p);
                });
                
                slokaMantraCell.appendChild(dhyanaContainer);
                slokaMantraCell.appendChild(mantraContainer);
            });
            return table;
        }
        
        // Function to create Collective Pooja table
        function createCollectivePoojaTable() {
            const table = document.createElement('table');
            const thead = table.createTHead();
            thead.insertRow().insertCell().innerHTML = `<b>Collective Shodasopachara Pooja (16 Services)</b>`;
            const tbody = table.createTBody();
            const prefix = "ॐ गणेशादि...देवताभ्यो नमः.";
            const services = [
                "आसनं समर्पयामि (Offer Seat with akshatas)",
                "पादयोः पाद्यं समर्पयामि (Offer water for feet)",
                "हस्तयोः अर्घ्यं समर्पयामि (Offer water for hands)",
                "मुखे शुद्धाचमनीयं समर्पयामि (Offer water for sipping)",
                "स्नपयामि (Offer bath with water)",
                "वस्त्राणि धारयामि (Offer clothes with akshatas)",
                "यज्ञोपवीतं समर्पयामि (Offer sacred thread with akshatas)",
                "गन्धान् धारयामि (Offer sandalwood paste, etc.)",
                "आभरणानि समर्पयामि (Offer ornaments with akshatas)",
                "पुष्पैः पूजयामि (Worship with flowers)",
                "धूपं आघ्रापयामि (Offer incense)",
                "दीपं दर्शयामि (Offer lamp)",
                "नैवेद्यं समर्पयामि (Offer food)",
                "ताम्बूलं समर्पयामि (Offer paan with akshatas)",
                "कर्पूरनीराजनं समर्पयामि (Offer camphor light)",
                "प्रदक्षिण नमस्कारान् समर्पयामि (Offer circumambulation and prostrations)"
            ];
            services.forEach(service => {
                const row = tbody.insertRow();
                row.insertCell().innerHTML = `<b>${prefix}</b> ${service}`;
            });
            return table;
        }
        
        function createGanapathiPoojaTable() {
            const table = document.createElement('table');
            const thead = table.createTHead();
            const headerRow = thead.insertRow();
            const headers = {
                "service": {"devanagari": "सेवा", "english": "Service", "telugu": "సేవ"},
                "mantra": {"devanagari": "मन्त्र", "english": "Mantra", "telugu": "మంత్రం"},
                "action": {"devanagari": "क्रिया", "english": "Action", "telugu": "క్రియ"}
            };

            Object.keys(headers).forEach(key => {
                const th = document.createElement('th');
                Object.keys(headers[key]).forEach(lang => {
                    const span = document.createElement('span');
                    span.className = `lang-${lang}`;
                    span.textContent = headers[key][lang];
                    th.appendChild(span);
                });
                headerRow.appendChild(th);
            });
            
            const tbody = table.createTBody();
            ganapathiPoojaServices.forEach(item => {
                const row = tbody.insertRow();
                const serviceCell = row.insertCell();
                const mantraCell = row.insertCell();
                const actionCell = row.insertCell();

                Object.keys(item.service).forEach(lang => {
                    const span = document.createElement('span');
                    span.className = `lang-${lang}`;
                    span.textContent = item.service[lang];
                    serviceCell.appendChild(span);
                });
                
                Object.keys(item.mantra).forEach(lang => {
                    const p = document.createElement('p');
                    p.className = `sloka-text lang-${lang}`;
                    p.style.whiteSpace = 'pre-wrap';
                    p.textContent = item.mantra[lang];
                    mantraCell.appendChild(p);
                });

                actionCell.textContent = item.action;
            });
            return table;
        }

        function createVarunaPoojaTable() {
            const table = document.createElement('table');
            const thead = table.createTHead();
            const headerRow = thead.insertRow();
            const headers = {
                "service": {"devanagari": "सेवा", "english": "Service", "telugu": "సేవ"},
                "mantra": {"devanagari": "मन्त्र", "english": "Mantra", "telugu": "మంత్రం"},
                "action": {"devanagari": "क्रिया", "english": "Action", "telugu": "క్రియ"}
            };

            Object.keys(headers).forEach(key => {
                const th = document.createElement('th');
                Object.keys(headers[key]).forEach(lang => {
                    const span = document.createElement('span');
                    span.className = `lang-${lang}`;
                    span.textContent = headers[key][lang];
                    th.appendChild(span);
                });
                headerRow.appendChild(th);
            });
            
            const tbody = table.createTBody();
            const varunaServices = JSON.parse(JSON.stringify(ganapathiPoojaServices)); // Deep copy
            varunaServices.forEach(item => {
                Object.keys(item.mantra).forEach(lang => {
                    item.mantra[lang] = item.mantra[lang].replace(/गं गणपतये/g, 'वं वरुणाय').replace(/Gam Ganapataye/g, 'Vam Varunaaya').replace(/గం గణపతయే/g, 'వం వరుణాయ');
                });

                const row = tbody.insertRow();
                const serviceCell = row.insertCell();
                const mantraCell = row.insertCell();
                const actionCell = row.insertCell();

                Object.keys(item.service).forEach(lang => {
                    const span = document.createElement('span');
                    span.className = `lang-${lang}`;
                    span.textContent = item.service[lang];
                    serviceCell.appendChild(span);
                });
                
                Object.keys(item.mantra).forEach(lang => {
                    const p = document.createElement('p');
                    p.className = `sloka-text lang-${lang}`;
                    p.style.whiteSpace = 'pre-wrap';
                    p.textContent = item.mantra[lang];
                    mantraCell.appendChild(p);
                });

                actionCell.textContent = item.action;
            });
            return table;
        }

        function createAngaPoojaTable() {
            const table = document.createElement('table');
            const thead = table.createTHead();
            const headerRow = thead.insertRow();
            const headers = {
                "service": {"devanagari": "सेवा", "english": "Service", "telugu": "సేవ"},
                "mantra": {"devanagari": "मन्त्र", "english": "Mantra", "telugu": "మంత్రం"},
                "action": {"devanagari": "क्रिया", "english": "Action", "telugu": "క్రియ"}
            };

            Object.keys(headers).forEach(key => {
                const th = document.createElement('th');
                Object.keys(headers[key]).forEach(lang => {
                    const span = document.createElement('span');
                    span.className = `lang-${lang}`;
                    span.textContent = headers[key][lang];
                    th.appendChild(span);
                });
                headerRow.appendChild(th);
            });
            
            const tbody = table.createTBody();
            angaPoojaServices.forEach(item => {
                const row = tbody.insertRow();
                const serviceCell = row.insertCell();
                const mantraCell = row.insertCell();
                const actionCell = row.insertCell();

                Object.keys(item.service).forEach(lang => {
                    const span = document.createElement('span');
                    span.className = `lang-${lang}`;
                    span.textContent = item.service[lang];
                    serviceCell.appendChild(span);
                });
                
                Object.keys(item.mantra).forEach(lang => {
                    const p = document.createElement('p');
                    p.className = `sloka-text lang-${lang}`;
                    p.style.whiteSpace = 'pre-wrap';
                    p.textContent = item.mantra[lang];
                    mantraCell.appendChild(p);
                });

                actionCell.textContent = item.action;
            });
            return table;
        }

        // Function to create content elements based on their type
        function createContentElement(element) {
            let el;
            switch (element.type) {
                case 'h3':
                    el = document.createElement('h3');
                    el.innerHTML = element.text;
                    break;
                case 'h4':
                    el = document.createElement('h4');
                    el.innerHTML = element.text;
                    break;
                case 'paragraph':
                    el = document.createElement('p');
                    el.innerHTML = element.text;
                    break;
                case 'list':
                    el = document.createElement('ul');
                    if (element.class) el.className = element.class;
                    element.items.forEach(itemText => {
                        const li = document.createElement('li');
                        li.innerHTML = itemText;
                        el.appendChild(li);
                    });
                    break;
                case 'table':
                    el = document.createElement('table');
                    const thead = el.createTHead();
                    const headerRow = thead.insertRow();
                    element.headers.forEach(headerText => {
                        const th = document.createElement('th');
                        th.innerHTML = headerText;
                        headerRow.appendChild(th);
                    });
                    const tbody = el.createTBody();
                    element.rows.forEach(rowData => {
                        const row = tbody.insertRow();
                        rowData.forEach(cellData => {
                            const cell = row.insertCell();
                            cell.innerHTML = cellData;
                        });
                    });
                    break;
                case 'sloka':
                    el = createSlokaElement(element);
                    break;
                case 'graha_table':
                    el = createGrahaTable();
                    break;
                case 'dikpalaka_table':
                    el = createDikpalakaTable();
                    break;
                case 'collective_pooja_table':
                    el = createCollectivePoojaTable();
                    break;
                case 'ganapathi_pooja_table':
                    el = createGanapathiPoojaTable();
                    break;
                case 'varuna_pooja_table':
                    el = createVarunaPoojaTable();
                    break;
                case 'anga_pooja_table':
                    el = createAngaPoojaTable();
                    break;
                default:
                    console.warn('Unknown content type:', element.type);
                    el = document.createElement('div');
                    el.innerHTML = `<p style="color: red;">Unknown content type: ${element.type}</p>`;
                    break;
            }
            return el;
        }

        // Function to build interactive steps with navigation
        function buildInteractiveStep(step, stepDiv) {
            if (step.description) {
                const description = document.createElement('p');
                description.textContent = step.description;
                stepDiv.appendChild(description);
            }
            
            // Create parts navigation
            const partsNav = document.createElement('div');
            partsNav.className = 'parivaara-parts-nav';
            step.parts.forEach((part, index) => {
                const partBtn = document.createElement('button');
                partBtn.textContent = part.title;
                partBtn.className = 'parivaara-part-btn';
                partBtn.dataset.partIndex = index;
                if (index === 0) partBtn.classList.add('active');
                
                partBtn.addEventListener('click', () => {
                    // Update active part
                    partsNav.querySelectorAll('.parivaara-part-btn').forEach(btn => {
                        btn.classList.remove('active');
                    });
                    partBtn.classList.add('active');
                    currentPart = index;
                    currentSubItem = 0;
                    updateInteractiveView(step, stepDiv);
                });
                
                partsNav.appendChild(partBtn);
            });
            stepDiv.appendChild(partsNav);
            
            // Create content container
            const contentContainer = document.createElement('div');
            contentContainer.className = 'parivaara-content';
            stepDiv.appendChild(contentContainer);
            
            // Initialize with first part
            updateInteractiveView(step, stepDiv);
        }
        
        // Function to build regular (non-interactive) steps
        function buildRegularStep(step, stepDiv) {
            // Add description if present
            if (step.description) {
                const description = document.createElement('p');
                description.textContent = step.description;
                stepDiv.appendChild(description);
            }
            
            // Add content array items
            if (step.content && step.content.length > 0) {
                step.content.forEach(item => {
                    try {
                        const element = createContentElement(item);
                        if (element) {
                            stepDiv.appendChild(element);
                        } else {
                            console.warn('createContentElement returned null/undefined for:', item);
                        }
                    } catch (error) {
                        console.error('Error creating content element:', error, item);
                        const errorDiv = document.createElement('div');
                        errorDiv.innerHTML = `<p style="color: red;">Error rendering content: ${item.type || 'unknown'}</p>`;
                        stepDiv.appendChild(errorDiv);
                    }
                });
            }
            
            // Add slokas if present
            if (step.slokas && step.slokas.length > 0) {
                step.slokas.forEach(sloka => {
                    stepDiv.appendChild(createSlokaElement(sloka));
                });
            }
        }
        
        // Function to update interactive view for current part/subitem
        function updateInteractiveView(step, stepDiv) {
            const contentContainer = stepDiv.querySelector('.parivaara-content');
            if (!contentContainer) return;
            
            contentContainer.innerHTML = ''; // Clear existing content
            
            const currentPartData = step.parts[currentPart];
            if (!currentPartData) return;
            
            // Add part title and description
            const partTitle = document.createElement('h3');
            partTitle.textContent = currentPartData.title;
            contentContainer.appendChild(partTitle);
            
            if (currentPartData.subtitle) {
                const subtitle = document.createElement('h4');
                subtitle.textContent = currentPartData.subtitle;
                contentContainer.appendChild(subtitle);
            }
            
            if (currentPartData.description) {
                const description = document.createElement('p');
                description.textContent = currentPartData.description;
                contentContainer.appendChild(description);
            }
            
            // Handle parts with sub-navigation
            if (currentPartData.hasSubNavigation && currentPartData.subItems) {
                if (currentPartData.id === 'part1') {
                    // Part 1: Lokapalakas
                    buildLokapalakaNavigation(currentPartData, contentContainer);
                } else if (currentPartData.id === 'part2') {
                    // Part 2: Grahas
                    buildGrahaNavigation(currentPartData, contentContainer);
                }
            } else {
                // Regular part content
                if (currentPartData.content && currentPartData.content.length > 0) {
                    currentPartData.content.forEach(item => {
                        try {
                            const element = createContentElement(item);
                            if (element) {
                                contentContainer.appendChild(element);
                            } else {
                                console.warn('createContentElement returned null/undefined for:', item);
                            }
                        } catch (error) {
                            console.error('Error creating content element:', error, item);
                            const errorDiv = document.createElement('div');
                            errorDiv.innerHTML = `<p style="color: red;">Error rendering content: ${item.type || 'unknown'}</p>`;
                            contentContainer.appendChild(errorDiv);
                        }
                    });
                }
            }
            
            // Update language display after content is rendered
            updateLanguage();
        }
        
        // Function to build graha navigation for Part 2
        function buildGrahaNavigation(partData, container) {
            // Create graha navigation
            const grahaNav = document.createElement('div');
            grahaNav.className = 'parivaara-graha-nav';
            
            partData.subItems.forEach((graha, index) => {
                const grahaBtn = document.createElement('button');
                grahaBtn.textContent = graha.name;
                grahaBtn.className = 'parivaara-graha-btn';
                grahaBtn.dataset.grahaIndex = index;
                if (index === 0) grahaBtn.classList.add('active');
                
                grahaBtn.addEventListener('click', () => {
                    // Update active graha
                    grahaNav.querySelectorAll('.parivaara-graha-btn').forEach(btn => {
                        btn.classList.remove('active');
                    });
                    grahaBtn.classList.add('active');
                    currentSubItem = index;
                    updateGrahaView(partData, container);
                    // Add small delay to ensure DOM is updated
                    setTimeout(() => {
                        updateGrahaDiagram(graha);
                    }, 50);
                });
                
                grahaNav.appendChild(grahaBtn);
            });
            
            container.appendChild(grahaNav);
            
            // Create graha diagram
            const diagramContainer = document.createElement('div');
            diagramContainer.className = 'graha-diagram-container';
            diagramContainer.innerHTML = createGrahaDiagram();
            container.appendChild(diagramContainer);
            
            // Load the SVG diagram
            loadPeetamSVG(() => {
                // Initialize highlighting after SVG is loaded
                setTimeout(() => {
                    updateGrahaDiagram(partData.subItems[0]);
                }, 200);
            });
            
            // Create graha content container
            const grahaContentContainer = document.createElement('div');
            grahaContentContainer.className = 'parivaara-graha-content';
            container.appendChild(grahaContentContainer);
            
            // Initialize with first graha
            updateGrahaView(partData, container);
        }
        
        // Function to update graha view for current graha
        function updateGrahaView(partData, container) {
            const grahaContentContainer = container.querySelector('.parivaara-graha-content');
            if (!grahaContentContainer) return;
            
            grahaContentContainer.innerHTML = ''; // Clear existing content
            
            const currentGraha = partData.subItems[currentSubItem];
            if (!currentGraha) return;
            
            // Add graha name and location
            const grahaTitle = document.createElement('h4');
            grahaTitle.textContent = `${currentGraha.name}${currentGraha.location ? ` (${currentGraha.location})` : ''}`;
            grahaContentContainer.appendChild(grahaTitle);
            
            if (currentGraha.attribute) {
                const attribute = document.createElement('p');
                attribute.className = 'graha-attribute';
                attribute.textContent = `Attribute: ${currentGraha.attribute}`;
                grahaContentContainer.appendChild(attribute);
            }
            
            // Add graha content
            if (currentGraha.content && currentGraha.content.length > 0) {
                currentGraha.content.forEach(item => {
                    try {
                        const element = createContentElement(item);
                        if (element) {
                            grahaContentContainer.appendChild(element);
                        } else {
                            console.warn('createContentElement returned null/undefined for:', item);
                        }
                    } catch (error) {
                        console.error('Error creating content element:', error, item);
                        const errorDiv = document.createElement('div');
                        errorDiv.innerHTML = `<p style="color: red;">Error rendering content: ${item.type || 'unknown'}</p>`;
                        grahaContentContainer.appendChild(errorDiv);
                    }
                });
            }
            
            // Update language display after graha content is rendered
            updateLanguage();
        }
        
        // Function to create graha diagram container that loads external SVG
        function createGrahaDiagram() {
            return `
                <div class="graha-diagram">
                    <h4>Graha Locations Diagram</h4>
                    <div id="peetam-svg-container">
                        Loading diagram...
                    </div>
                </div>
            `;
        }
        
        // Function to load the external SVG diagram
        async function loadPeetamSVG(callback) {
            try {
                const response = await fetch('./peetam.svg');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const svgText = await response.text();
                
                // Insert the SVG into the container
                const container = document.getElementById('peetam-svg-container');
                if (container) {
                    container.innerHTML = svgText;
                    
                    // Adjust SVG viewBox to ensure all content is visible
                    const svg = container.querySelector('svg');
                    if (svg) {
                        // Add some padding to the viewBox to ensure edge labels are visible
                        svg.setAttribute('viewBox', '-20 -20 940 790'); // Original was 0 0 900 750
                        svg.setAttribute('preserveAspectRatio', 'xMidYMid meet');
                    }
                    
                    // Call callback if provided
                    if (callback) {
                        // Use setTimeout to ensure SVG is fully rendered
                        setTimeout(callback, 100);
                    }
                }
            } catch (error) {
                console.error('Failed to load peetam diagram:', error);
                const container = document.getElementById('peetam-svg-container');
                if (container) {
                    container.innerHTML = '<p style="color: #888; text-align: center; padding: 20px;">Diagram could not be loaded</p>';
                }
            }
        }        
        // Function to update graha diagram highlighting
        function updateGrahaDiagram(graha) {
            if (!graha || !graha.name) return;
            
            // Wait a bit to ensure SVG is fully loaded
            setTimeout(() => {
                const svg = document.querySelector('.graha-diagram svg');
                if (!svg) return;
                
                // Reset all highlights by removing classes and arrows
                svg.querySelectorAll('g').forEach(group => {
                    group.classList.remove('highlight-main', 'highlight-deity');
                });
                
                // Remove any existing arrows
                svg.querySelectorAll('.attention-arrow').forEach(arrow => arrow.remove());
                
                // Get SVG IDs from mapping using graha name
                const mapping = grahaMapping[graha.name];
                if (!mapping) {
                    console.warn('Graha mapping not found for:', graha.name);
                    return;
                }
                
                const mainLocation = mapping.main;
                const rulingLocation = mapping.ruling;
                const corulingLocation = mapping.coruling;
                
                console.log('Highlighting graha:', graha.name, 'at locations:', mainLocation, rulingLocation, corulingLocation);
                
                // Find and highlight the groups
                const mainGroup = svg.querySelector(`#${mainLocation}`);
                const rulingGroup = svg.querySelector(`#${rulingLocation}`);
                const corulingGroup = svg.querySelector(`#${corulingLocation}`);
                
                if (mainGroup) {
                    mainGroup.classList.add('highlight-main');
                    
                    // Add attention arrow near the main graha
                    const bbox = mainGroup.getBBox();
                    const arrow = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                    arrow.setAttribute('x', bbox.x + bbox.width + 10);
                    arrow.setAttribute('y', bbox.y - 10);
                    arrow.setAttribute('class', 'attention-arrow');
                    arrow.setAttribute('fill', '#ff5722');
                    arrow.setAttribute('font-size', '24');
                    arrow.setAttribute('font-weight', 'bold');
                    arrow.textContent = '←';
                    arrow.style.animation = 'bounce 1.5s infinite';
                    svg.appendChild(arrow);
                    
                    console.log('Highlighted main group:', mainLocation);
                } else {
                    console.warn('Main group not found:', mainLocation);
                }
                
                if (rulingGroup) {
                    rulingGroup.classList.add('highlight-deity');
                    console.log('Highlighted ruling group:', rulingLocation);
                } else {
                    console.warn('Ruling group not found:', rulingLocation);
                }
                
                if (corulingGroup) {
                    corulingGroup.classList.add('highlight-deity');
                    console.log('Highlighted co-ruling group:', corulingLocation);
                } else {
                    console.warn('Co-ruling group not found:', corulingLocation);
                }
            }, 100);
        }

        // Function to build Lokapalaka navigation for Part 1
        function buildLokapalakaNavigation(partData, container) {
            // Create lokapalaka navigation
            const lokapalakaNav = document.createElement('div');
            lokapalakaNav.className = 'parivaara-graha-nav';
            
            partData.subItems.forEach((lokapalaka, index) => {
                const lokapalakaBtn = document.createElement('button');
                lokapalakaBtn.textContent = lokapalaka.name;
                lokapalakaBtn.className = 'parivaara-graha-btn';
                lokapalakaBtn.dataset.lokapalakaIndex = index;
                if (index === 0) lokapalakaBtn.classList.add('active');
                
                lokapalakaBtn.addEventListener('click', () => {
                    // Update active lokapalaka
                    lokapalakaNav.querySelectorAll('.parivaara-graha-btn').forEach(btn => {
                        btn.classList.remove('active');
                    });
                    lokapalakaBtn.classList.add('active');
                    currentSubItem = index;
                    updateLokapalakaView(partData, container);
                    // Add small delay to ensure DOM is updated
                    setTimeout(() => {
                        updateLokapalakaDiagram(lokapalaka);
                    }, 50);
                });
                
                lokapalakaNav.appendChild(lokapalakaBtn);
            });
            
            container.appendChild(lokapalakaNav);
            
            // Create lokapalaka diagram
            const diagramContainer = document.createElement('div');
            diagramContainer.className = 'graha-diagram-container';
            diagramContainer.innerHTML = createGrahaDiagram();
            container.appendChild(diagramContainer);
            
            // Load the SVG diagram
            loadPeetamSVG(() => {
                // Initialize highlighting after SVG is loaded
                setTimeout(() => {
                    updateLokapalakaDiagram(partData.subItems[0]);
                }, 200);
            });
            
            // Create lokapalaka content container
            const lokapalakaContentContainer = document.createElement('div');
            lokapalakaContentContainer.className = 'parivaara-graha-content';
            container.appendChild(lokapalakaContentContainer);
            
            // Initialize with first lokapalaka
            updateLokapalakaView(partData, container);
        }
        
        // Function to update lokapalaka view for current lokapalaka
        function updateLokapalakaView(partData, container) {
            const lokapalakaContentContainer = container.querySelector('.parivaara-graha-content');
            if (!lokapalakaContentContainer) return;
            
            lokapalakaContentContainer.innerHTML = ''; // Clear existing content
            
            const currentLokapalaka = partData.subItems[currentSubItem];
            if (!currentLokapalaka) return;
            
            // Add lokapalaka name and element
            const lokapalakaTitle = document.createElement('h4');
            lokapalakaTitle.textContent = `${currentLokapalaka.name}${currentLokapalaka.element ? ` (${currentLokapalaka.element} Element)` : ''}`;
            lokapalakaContentContainer.appendChild(lokapalakaTitle);
            
            // Add lokapalaka content
            if (currentLokapalaka.content && currentLokapalaka.content.length > 0) {
                currentLokapalaka.content.forEach(item => {
                    try {
                        const element = createContentElement(item);
                        if (element) {
                            lokapalakaContentContainer.appendChild(element);
                        } else {
                            console.warn('createContentElement returned null/undefined for:', item);
                        }
                    } catch (error) {
                        console.error('Error creating content element:', error, item);
                        const errorDiv = document.createElement('div');
                        errorDiv.innerHTML = `<p style="color: red;">Error rendering content: ${item.type || 'unknown'}</p>`;
                        lokapalakaContentContainer.appendChild(errorDiv);
                    }
                });
            }
            
            // Update language display after lokapalaka content is rendered
            updateLanguage();
        }
        
        // Function to update lokapalaka diagram highlighting
        function updateLokapalakaDiagram(lokapalaka) {
            if (!lokapalaka || !lokapalaka.name) return;
            
            // Wait a bit to ensure SVG is fully loaded
            setTimeout(() => {
                const svg = document.querySelector('.graha-diagram svg');
                if (!svg) return;
                
                // Reset all highlights by removing classes and arrows
                svg.querySelectorAll('g').forEach(group => {
                    group.classList.remove('highlight-main', 'highlight-deity');
                });
                
                // Remove any existing arrows
                svg.querySelectorAll('.attention-arrow').forEach(arrow => arrow.remove());
                
                // Get SVG IDs from mapping using lokapalaka name
                const mapping = lokapalakaMapping[lokapalaka.name];
                if (!mapping) {
                    console.warn('Lokapalaka mapping not found for:', lokapalaka.name);
                    return;
                }
                
                const mainLocation = mapping.main;
                
                console.log('Highlighting lokapalaka:', lokapalaka.name, 'at location:', mainLocation);
                
                // Find and highlight the group
                const mainGroup = svg.querySelector(`#${mainLocation}`);
                
                if (mainGroup) {
                    mainGroup.classList.add('highlight-main');
                    
                    // Add attention arrow near the main lokapalaka
                    // Dynamically calculate position using SVG element's actual coordinates
                    try {
                        // Get the text element inside the group
                        const textElement = mainGroup.querySelector('text');
                        if (textElement) {
                            // Get the bounding box of the text element
                            const bbox = textElement.getBBox();
                            
                            // Get the cumulative transform matrix from all parent groups
                            const transform = textElement.getCTM();
                            
                            // Calculate the actual screen coordinates
                            let x, y;
                            if (transform) {
                                // Use the transform matrix to get actual position
                                // For SVG text, the y coordinate is the baseline, so we use it directly
                                x = transform.e + bbox.x;
                                y = transform.f + parseFloat(textElement.getAttribute('y')) - 50; // Use the actual y attribute
                            } else {
                                // Fallback to bbox if no transform
                                x = bbox.x;
                                y = bbox.y + bbox.height * 1.5;
                            }
                            
                            // Create the arrow
                            const arrow = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                            arrow.setAttribute('x', x - 60); // Position to the left
                            arrow.setAttribute('y', y); // Position above the text
                            arrow.setAttribute('class', 'attention-arrow');
                            arrow.setAttribute('fill', '#ff5722');
                            arrow.setAttribute('font-size', '20');
                            arrow.setAttribute('font-weight', 'bold');
                            arrow.textContent = '→';
                            arrow.style.animation = 'bounce 1.5s infinite';
                            svg.appendChild(arrow);
                            
                            console.log(`Added arrow for ${mainLocation} at calculated position:`, x - 25, y);
                        } else {
                            console.warn('Text element not found in group:', mainLocation);
                        }
                    } catch (error) {
                        console.error('Error calculating position for arrow:', error);
                        // Fallback: use getBBox on the group itself
                        try {
                            const bbox = mainGroup.getBBox();
                            const arrow = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                            arrow.setAttribute('x', bbox.x - 60 ); // Position to the left
                            arrow.setAttribute('y', bbox.y + bbox.height * 1.5 ); // Center vertically
                            arrow.setAttribute('class', 'attention-arrow');
                            arrow.setAttribute('fill', '#ff5722');
                            arrow.setAttribute('font-size', '20');
                            arrow.setAttribute('font-weight', 'bold');
                            arrow.textContent = '→';
                            arrow.style.animation = 'bounce 1.5s infinite';
                            svg.appendChild(arrow);
                            console.log(`Added fallback arrow for ${mainLocation}`);
                        } catch (fallbackError) {
                            console.error('Fallback arrow positioning also failed:', fallbackError);
                        }
                    }
                    
                    console.log('Highlighted main group:', mainLocation);
                } else {
                    console.warn('Main group not found:', mainLocation);
                }
            }, 100);
        }

        // Function to build the entire page structure from the JSON data
        function buildSteps() {
            steps.forEach((step, index) => {
                // 1. Build Navbar links
                const navLink = document.createElement('a');
                navLink.href = `#${step.id}`;
                navLink.textContent = step.title;
                navLink.dataset.index = index;
                navbar.appendChild(navLink);

                // 2. Build Step Content sections
                const stepDiv = document.createElement('div');
                stepDiv.id = step.id;
                stepDiv.className = 'step-content';
                
                const title = document.createElement('h2');
                title.textContent = step.title;
                stepDiv.appendChild(title);

                // Handle interactive steps (like step 10)
                if (step.isInteractive && step.parts) {
                    buildInteractiveStep(step, stepDiv);
                } else {
                    // Handle regular steps
                    buildRegularStep(step, stepDiv);
                }
                
                mainContent.appendChild(stepDiv);
            });
        }

        // Function to update the view based on the current step
        function updateView() {
            // Track the furthest step reached for progression styling
            if (currentStep > maxStepReached) {
                maxStepReached = currentStep;
            }

            // Reset interactive navigation when changing steps
            currentPart = 0;
            currentSubItem = 0;

            // Update visibility of the main content sections
            document.querySelectorAll('.step-content').forEach((div, index) => {
                div.classList.toggle('active', index === currentStep);
                
                // Re-initialize interactive step if it's currently active
                if (index === currentStep && steps[index].isInteractive && steps[index].parts) {
                    // Find the step div and re-initialize it
                    updateInteractiveView(steps[index], div);
                }
            });

            // Update styling of the navbar links
            document.querySelectorAll('#navbar a').forEach((link, index) => {
                link.classList.remove('active', 'completed');
                if (index === currentStep) {
                    link.classList.add('active');
                    // Scroll the active link into view on the navbar
                    link.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
                }
                if (index < maxStepReached) {
                    link.classList.add('completed');
                }
            });

            // Enable/disable navigation buttons
            prevBtn.disabled = currentStep === 0;
            nextBtn.disabled = currentStep === steps.length - 1;

            // Update which language is shown for slokas
            updateLanguage();
        }

        // Function to show/hide slokas based on language selection
        function updateLanguage() {
            const selectedLang = languageSelect.value;
            document.querySelectorAll('.sloka-text, th span, td span').forEach(p => {
                if (p.classList.contains(`lang-${selectedLang}`)) {
                    p.style.display = '';
                } else if (p.tagName === 'SPAN') {
                    p.style.display = 'none';
                }
            });
            document.querySelectorAll('.sloka-text').forEach(p => {
                p.style.display = 'none';
            });
            document.querySelectorAll(`.sloka-text.lang-${selectedLang}`).forEach(p => {
                p.style.display = 'block';
            });
        }
        
        // --- Event Listeners ---
        prevBtn.addEventListener('click', () => {
            if (currentStep > 0) {
                currentStep--;
                updateView();
                window.scrollTo(0, 0); // Scroll to top on step change
            }
        });

        nextBtn.addEventListener('click', () => {
            if (currentStep < steps.length - 1) {
                currentStep++;
                updateView();
                window.scrollTo(0, 0); // Scroll to top on step change
            }
        });

        navbar.addEventListener('click', (e) => {
            if (e.target.tagName === 'A' && e.target.dataset.index) {
                e.preventDefault();
                const index = parseInt(e.target.dataset.index, 10);
                // Allow jumping to any completed step or the one immediately after
                if(index <= maxStepReached + 1 || index === 0) { 
                    currentStep = index;
                    updateView();
                    window.scrollTo(0, 0); // Scroll to top on step change
                }
            }
        });

        languageSelect.addEventListener('change', updateLanguage);

        // --- Initialisation ---
        buildSteps();
        updateView();
        
        } catch (error) {
            console.error('Error loading JSON data:', error);
            // Display error message to user
            const mainContent = document.getElementById('main-content');
            mainContent.innerHTML = `
                <div style="text-align: center; padding: 40px;">
                    <h2 style="color: #d32f2f;">Error Loading Content</h2>
                    <p>Sorry, there was an error loading the vratam content. Please ensure the vratam.json file is accessible.</p>
                    <p style="color: #666; font-size: 0.9em;">Error: ${error.message}</p>
                </div>
            `;
        }
    });
    </script>
</body>
</html>
